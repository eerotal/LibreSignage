var $ = require('jquery');
var BaseValidator = require('./basevalidator.js');

module.exports = class FileSelectorValidator extends BaseValidator {
	/*
	*  Validate a file selector input.
	*
	*  Settings:
	*    * mimes     = An array of accepted file MIME types.
	*    * name_len  = The maximum allowed filename length.
	*    * regex     = A "whitelist" regex for filenames.
	*    * minfiles  = Minimum number of selected files.
	*    * bl        = A blacklist of files to disallow.
	*                  This can be a getter function or an
	*                  array.
	*/
	constructor(...args) {
		super(...args);
		this.chk_settings(
			['mimes', 'name_len', 'regex', 'minfiles', 'bl']
		);
	}

	validate(selector) {
		let ret = true;
		var mimes = this.settings.mimes;
		var name_len = this.settings.name_len;
		var regex = this.settings.regex;
		var minfiles = this.settings.minfiles;

		var bl = null;
		if (typeof this.settings.bl === 'function') {
			bl = this.settings.bl();
		} else {
			bl = this.settings.bl;
		}

		selector.query.each(function() {
			if (minfiles != null && this.files.length < minfiles) {
				ret = false;
				return false;
			}

			for (let i = 0; i < this.files.length; i++) {
				if (
					(
						name_len != null
						&& this.files.item(i).name.length > name_len
					) || (
						mimes != null
						&& !mimes.includes(this.files.item(i).type)
					) || (
						regex != null
						&& !this.files.item(i).name.match(regex)
					) || (
						bl != null
						&& bl.length != 0
						&& bl.includes(this.files.item(i).name)
					)
				) {
					ret = false;
					return false;
				}
			}
		});
		return ret;
	}
}
